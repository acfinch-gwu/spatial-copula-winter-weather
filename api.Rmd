```{r}
library(httr)
library(rvest)
library(stringr)
library(glue)
library(fs)
```
# ------------------------------------------------------------
# PARAMETERS
# ------------------------------------------------------------
```{r}
years <- 2021:2025
out_dir <- "rdpa_grids"
dir_create("data/out_dir")

base_url <- "https://dd.weather.gc.ca/analysis/precip/rdpa/grib2"
```
# ------------------------------------------------------------
# FUNCTION: LIST FILES IN A DIRECTORY
# ------------------------------------------------------------
```{r}
list_grib_files <- function(url) {
  # Parse HTML index, extract file links
  html <- read_html(url)
  files <- html %>%
    html_nodes("a") %>%
    html_attr("href") %>%
    str_subset("\\.grib2$")
  return(files)
}
```
# ------------------------------------------------------------
# FUNCTION: DOWNLOAD A GRIB2 FILE SAFELY
# ------------------------------------------------------------
```{r}
download_file <- function(url, dest) {
  if (file_exists(dest)) {
    message("Already exists: ", dest)
    return(invisible(FALSE))
  }
  tryCatch({
    GET(url, write_disk(dest, overwrite = TRUE), timeout(300))
    message("Downloaded: ", dest)
    TRUE
  }, error = function(e) {
    message("Download error for ", url, ": ", e)
    FALSE
  })
}
```
# ------------------------------------------------------------
# MAIN BULK DOWNLOAD LOOP
# ------------------------------------------------------------
```{r}
for (yy in years) {
  for (mm in sprintf("%02d", 1:12)) {
    
    month_url <- glue("{base_url}/{yy}/{mm}/")
    message("Listing: ", month_url)
    
    # List GRIB2 files for the month
    files <- try(list_grib_files(month_url), silent = TRUE)
    
    if (inherits(files, "try-error") || length(files) == 0) {
      message("No files or error for: ", month_url)
      next
    }
    
    # Download each file
    for (f in files) {
      file_url <- glue("{month_url}{f}")
      dest <- path(out_dir, f)
      download_file(file_url, dest)
      Sys.sleep(1)
    }
  }
}

```